<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Cronograma</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f5; /* zinc-100 */
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #a8a29e; /* stone-400 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #78716c; /* stone-500 */
        }
        .palette-editing {
            outline: 2px dashed #4f46e5; /* indigo-600 */
            border-radius: 8px;
            padding: 4px;
        }
        /* Style for print */
        @media print {
            @page {
                size: A4 landscape; /* Suggest landscape for more horizontal space */
                margin: 0.7cm; /* Reduce page margins */
            }
            body, html {
                width: 100%;
                height: auto;
                -webkit-print-color-adjust: exact !important; /* Force colors to print in Chrome/Safari */
                color-adjust: exact !important; /* Standard property for printing colors */
            }
            .no-print {
                display: none;
            }
            table {
                width: 100%;
                border-collapse: collapse;A
            }
            #timetable {
                min-width: 100%;
                table-layout: auto;
            }
            th, td {
                border: 1px solid #ddd;
                padding: 2px;
                font-size: 8px; /* Further reduced font size */
                word-break: break-word; 
            }
            th {
                background-color: #f2f2f2 !important; /* Ensure background prints */
            }
            .time-col {
                width: auto; 
                min-width: 0;
                white-space: nowrap;
            }
            /* Ensure colored cells print their background */
            #timetable div[style*="background-color"] {
                background-color: inherit !important;
            }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 no-print">
            <h1 class="text-4xl font-bold text-zinc-800">Meu Cronograma Semanal</h1>
            <p class="text-zinc-500 mt-2">Clique em um horário para adicionar uma disciplina ou defina um horário recorrente abaixo.</p>
        </header>

        <!-- Timetable Section -->
        <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg">
            <div id="timetable-wrapper" class="overflow-x-auto custom-scrollbar">
                <table id="timetable" class="w-full min-w-[1000px] border-collapse text-center">
                    <thead class="bg-zinc-50">
                        <!-- Table header will be generated by JS -->
                    </thead>
                    <tbody>
                        <!-- Table body will be generated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="text-center mt-6 no-print">
             <button id="print-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                Imprimir Horário
            </button>
            <button id="clear-all-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 ml-4">
                Limpar Tudo
            </button>
        </div>


        <!-- Disciplines Management Section -->
        <div class="mt-10 no-print">
            <h2 class="text-2xl font-bold text-zinc-800 mb-4">Gerenciar Disciplinas</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Add/Edit Discipline Form -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 id="form-title" class="text-xl font-semibold mb-4 text-zinc-700">Adicionar Nova Disciplina</h3>
                    <form id="discipline-form" class="space-y-4">
                        <input type="hidden" id="discipline-id">
                        <div>
                            <label for="discipline-name" class="block text-sm font-medium text-zinc-600">Nome da Disciplina</label>
                            <input type="text" id="discipline-name" class="mt-1 block w-full px-3 py-2 bg-white border border-zinc-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                        </div>
                        <div>
                            <label for="discipline-abbr" class="block text-sm font-medium text-zinc-600">Abreviação (Ex: AED)</label>
                            <input type="text" id="discipline-abbr" class="mt-1 block w-full px-3 py-2 bg-white border border-zinc-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                        </div>
                        <div>
                            <label for="discipline-teacher" class="block text-sm font-medium text-zinc-600">Docente</label>
                            <input type="text" id="discipline-teacher" class="mt-1 block w-full px-3 py-2 bg-white border border-zinc-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="discipline-room" class="block text-sm font-medium text-zinc-600">Sala/Local</label>
                            <input type="text" id="discipline-room" class="mt-1 block w-full px-3 py-2 bg-white border border-zinc-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="discipline-color" class="block text-sm font-medium text-zinc-600">Cor</label>
                            <input type="color" id="discipline-color" value="#a7f3d0" class="mt-1 block w-full h-10 px-1 py-1 bg-white border border-zinc-300 rounded-md shadow-sm cursor-pointer">
                        </div>
                        <div>
                            <div class="flex justify-between items-center mt-2">
                                <label class="block text-sm font-medium text-zinc-600">Paleta de Cores</label>
                                <div>
                                    <button type="button" id="edit-palette-btn" class="text-sm text-indigo-600 hover:text-indigo-800">Editar Paleta</button>
                                    <button type="button" id="save-palette-btn" class="text-sm text-green-600 hover:text-green-800 hidden">Salvar Paleta</button>
                                    <button type="button" id="reset-palette-btn" class="text-sm text-red-600 hover:text-red-800 ml-2 hidden">Resetar</button>
                                </div>
                            </div>
                            <div id="color-palette" class="flex flex-wrap gap-2 mt-2 p-1">
                                <!-- Color swatches will be generated by JS -->
                            </div>
                        </div>

                        <!-- Recurring Schedule Section -->
                        <div class="border-t pt-4">
                            <h4 class="text-md font-semibold text-zinc-700 mb-2">Horário Recorrente (Opcional)</h4>
                            <p class="text-sm text-zinc-500 mb-3">Preencha para adicionar/atualizar a disciplina automaticamente no cronograma.</p>
                            <div class="mb-3">
                                <label class="block text-sm font-medium text-zinc-600 mb-2">Dias da Semana</label>
                                <div id="schedule-days" class="flex flex-wrap gap-x-4 gap-y-2">
                                    <!-- Checkboxes will be generated by JS -->
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="schedule-start-time" class="block text-sm font-medium text-zinc-600">Hora Início</label>
                                    <input type="time" id="schedule-start-time" step="3600" class="mt-1 block w-full px-3 py-2 bg-white border border-zinc-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="schedule-end-time" class="block text-sm font-medium text-zinc-600">Hora Fim</label>
                                    <input type="time" id="schedule-end-time" step="3600" class="mt-1 block w-full px-3 py-2 bg-white border border-zinc-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-4 pt-4">
                            <button type="submit" id="save-discipline-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Salvar Disciplina</button>
                            <button type="button" id="cancel-edit-btn" class="w-full flex justify-center py-2 px-4 border border-zinc-300 rounded-md shadow-sm text-sm font-medium text-zinc-700 bg-white hover:bg-zinc-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-zinc-500 hidden">Cancelar Edição</button>
                        </div>
                    </form>
                </div>

                <!-- Disciplines List -->
                <div id="disciplines-list-container" class="bg-white p-6 rounded-2xl shadow-lg">
                     <h3 class="text-xl font-semibold mb-4 text-zinc-700">Minhas Disciplinas</h3>
                     <div id="disciplines-list" class="space-y-3">
                        <!-- List will be generated by JS -->
                     </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for selecting discipline -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Selecione a Disciplina</h3>
                <div class="mt-2 px-7 py-3">
                    <select id="modal-discipline-select" class="w-full px-3 py-2 bg-white border border-zinc-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <!-- Options will be generated by JS -->
                    </select>
                </div>
                <div class="items-center px-4 py-3 gap-4 flex">
                    <button id="modal-save" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        Salvar
                    </button>
                    <button id="modal-clear" class="px-4 py-2 bg-orange-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-300">
                        Limpar
                    </button>
                    <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const timetable = document.getElementById('timetable');
            const modal = document.getElementById('modal');
            const modalSelect = document.getElementById('modal-discipline-select');
            const disciplineForm = document.getElementById('discipline-form');
            const disciplinesList = document.getElementById('disciplines-list');
            const formTitle = document.getElementById('form-title');
            const disciplineIdInput = document.getElementById('discipline-id');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const scheduleDaysContainer = document.getElementById('schedule-days');
            const colorPalette = document.getElementById('color-palette');
            const colorInput = document.getElementById('discipline-color');
            const editPaletteBtn = document.getElementById('edit-palette-btn');
            const savePaletteBtn = document.getElementById('save-palette-btn');
            const resetPaletteBtn = document.getElementById('reset-palette-btn');

            // --- APP STATE & CONFIG ---
            let disciplines = [];
            let timetableData = {};
            let currentCellId = null;
            let isEditingPalette = false;

            const days = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
            const startTime = 5;
            const endTime = 23;
            const defaultColors = [
                '#fecaca', '#fed7aa', '#fef08a', '#d9f99d', '#a7f3d0', '#bfdbfe',
                '#c7d2fe', '#e9d5ff', '#fbcfe8', '#fce7f3', '#e5e7eb', '#d1d5db'
            ];
            let predefinedColors = [...defaultColors];

            const defaultDisciplines = [
                { id: 1, name: 'Lógica para computação', abbr: 'LC', teacher: 'ROSALVO NETO', room: 'sala 06', color: '#a7f3d0' },
                { id: 2, name: 'Algoritmo e estrutura de dados', abbr: 'AED', teacher: 'Linder', room: '', color: '#bfdbfe' },
                { id: 3, name: 'Eletrônica digital', abbr: 'ED', teacher: 'Max', room: '', color: '#fbcfe8' },
                { id: 4, name: 'Laboratório de eletrônica Digital', abbr: 'LabED', teacher: 'Max', room: '', color: '#fef08a' },
                { id: 5, name: 'Dormir', abbr: 'DORMIR', teacher: '', room: '', color: '#e5e7eb' },
            ];

            // --- DATA PERSISTENCE ---
            const saveData = () => {
                localStorage.setItem('timetable_disciplines', JSON.stringify(disciplines));
                localStorage.setItem('timetable_data', JSON.stringify(timetableData));
                localStorage.setItem('timetable_color_palette', JSON.stringify(predefinedColors));
            };

            const loadData = () => {
                const storedDisciplines = localStorage.getItem('timetable_disciplines');
                const storedTimetableData = localStorage.getItem('timetable_data');
                const storedPalette = localStorage.getItem('timetable_color_palette');

                if (storedDisciplines) {
                    disciplines = JSON.parse(storedDisciplines);
                } else {
                    disciplines = defaultDisciplines;
                }
                
                if (storedTimetableData) {
                    timetableData = JSON.parse(storedTimetableData);
                }

                if (storedPalette) {
                    predefinedColors = JSON.parse(storedPalette);
                } else {
                    predefinedColors = [...defaultColors];
                }
            };

            // --- RENDER FUNCTIONS ---
            const renderTimetable = () => {
                timetable.innerHTML = '';
                const thead = timetable.createTHead();
                thead.classList.add('bg-zinc-50');
                const headerRow = thead.insertRow();
                const timeHeader = document.createElement('th');
                timeHeader.className = 'p-1 border border-zinc-200 sticky left-0 bg-zinc-50 z-10 time-col';
                timeHeader.textContent = 'Horário';
                headerRow.appendChild(timeHeader);
                days.forEach(day => {
                    const th = document.createElement('th');
                    th.className = 'p-1 border border-zinc-200 min-w-[120px]';
                    th.textContent = day;
                    headerRow.appendChild(th);
                });

                const tbody = timetable.createTBody();
                for (let hour = startTime; hour < endTime; hour++) {
                    const timeStr = `${String(hour).padStart(2, '0')}:00`;
                    const nextHourStr = `${String(hour + 1).padStart(2, '0')}:00`;
                    const timeRangeStr = `${timeStr} ~ ${nextHourStr}`;
                    
                    const row = tbody.insertRow();
                    
                    const timeCell = row.insertCell();
                    timeCell.textContent = timeRangeStr;
                    timeCell.className = 'p-1 border border-zinc-200 font-mono text-xs text-zinc-500 sticky left-0 bg-white z-10 time-col whitespace-nowrap';

                    days.forEach(day => {
                        const cell = row.insertCell();
                        const cellId = `${day}-${timeStr}`;
                        cell.id = cellId;
                        cell.className = 'p-0 border border-zinc-200 h-12 cursor-pointer hover:bg-zinc-100 transition-colors duration-200';
                        cell.addEventListener('click', () => onCellClick(cellId));
                        updateCell(cellId);
                    });
                }
            };

            const updateCell = (cellId) => {
                const cell = document.getElementById(cellId);
                if (!cell) return;
                const disciplineId = timetableData[cellId];
                if (disciplineId) {
                    const discipline = disciplines.find(d => d.id == disciplineId);
                    if (discipline) {
                        cell.innerHTML = `<div class="w-full h-full flex flex-col items-center justify-center text-xs font-semibold p-1 overflow-hidden" style="background-color: ${discipline.color};">
                            <span>${discipline.abbr}</span>
                            <span class="text-[10px] font-normal hidden sm:block truncate">${discipline.teacher || ''}</span>
                            <span class="text-[10px] font-normal hidden sm:block text-zinc-600 truncate">${discipline.room || ''}</span>
                        </div>`;
                    }
                } else {
                    cell.innerHTML = '';
                    cell.style.backgroundColor = '';
                }
            };

            const renderDisciplinesList = () => {
                disciplinesList.innerHTML = '';
                if(disciplines.length === 0) {
                    disciplinesList.innerHTML = `<p class="text-zinc-500">Nenhuma disciplina adicionada ainda.</p>`;
                    return;
                }
                disciplines.forEach(d => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 rounded-lg border border-zinc-200';
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-5 h-5 rounded-full" style="background-color: ${d.color};"></div>
                            <div>
                                <p class="font-semibold">${d.name} (${d.abbr})</p>
                                <p class="text-sm text-zinc-500">${d.teacher || 'Sem docente'} - ${d.room || 'Sem sala'}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button data-id="${d.id}" class="edit-btn text-blue-500 hover:text-blue-700">Editar</button>
                            <button data-id="${d.id}" class="delete-btn text-red-500 hover:text-red-700">Excluir</button>
                        </div>
                    `;
                    disciplinesList.appendChild(div);
                });
                document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', onEditDiscipline));
                document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', onDeleteDiscipline));
            };
            
            const populateModalSelect = () => {
                modalSelect.innerHTML = '<option value="">-- Limpar Célula --</option>';
                disciplines.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d.id;
                    option.textContent = `${d.name} (${d.abbr})`;
                    modalSelect.appendChild(option);
                });
            };
            
            const renderDayCheckboxes = () => {
                scheduleDaysContainer.innerHTML = '';
                days.forEach(day => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    div.innerHTML = `
                        <input id="day-${day}" name="schedule-day" type="checkbox" value="${day}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="day-${day}" class="ml-2 block text-sm text-gray-900">${day}</label>
                    `;
                    scheduleDaysContainer.appendChild(div);
                });
            };

            const renderColorPalette = () => {
                colorPalette.innerHTML = '';
                predefinedColors.forEach((color, index) => {
                    const swatch = document.createElement('div');
                    swatch.className = 'w-8 h-8 rounded-full cursor-pointer border-2 border-transparent hover:border-zinc-500 transition-all';
                    swatch.style.backgroundColor = color;
                    swatch.dataset.color = color;
                    swatch.dataset.index = index;
                    swatch.addEventListener('click', onSwatchClick);
                    colorPalette.appendChild(swatch);
                });
            };

            const updatePaletteSelection = (selectedColor) => {
                document.querySelectorAll('#color-palette div').forEach(swatch => {
                    if (swatch.dataset.color.toLowerCase() === selectedColor.toLowerCase()) {
                        swatch.classList.add('border-zinc-800', 'scale-110');
                        swatch.classList.remove('border-transparent');
                    } else {
                        swatch.classList.remove('border-zinc-800', 'scale-110');
                        swatch.classList.add('border-transparent');
                    }
                });
            };

            // --- EVENT HANDLERS ---
            const onSwatchClick = (e) => {
                const swatch = e.target;
                const selectedColor = swatch.dataset.color;

                if (isEditingPalette) {
                    const index = parseInt(swatch.dataset.index);
                    const tempColorInput = document.createElement('input');
                    tempColorInput.type = 'color';
                    tempColorInput.value = selectedColor;
                    tempColorInput.style.display = 'none';
                    document.body.appendChild(tempColorInput);
                    
                    tempColorInput.addEventListener('input', (event) => {
                        const newColor = event.target.value;
                        predefinedColors[index] = newColor;
                        renderColorPalette();
                        updatePaletteSelection(newColor);
                        document.body.removeChild(tempColorInput);
                    }, { once: true });

                    tempColorInput.click();
                } else {
                    colorInput.value = selectedColor;
                    updatePaletteSelection(selectedColor);
                }
            };

            colorInput.addEventListener('input', (e) => {
                updatePaletteSelection(e.target.value);
            });

            const onCellClick = (cellId) => {
                currentCellId = cellId;
                populateModalSelect();
                const currentDisciplineId = timetableData[cellId];
                modalSelect.value = currentDisciplineId || '';
                modal.classList.remove('hidden');
            };

            const closeModal = () => {
                modal.classList.add('hidden');
                currentCellId = null;
            };

            document.getElementById('modal-save').addEventListener('click', () => {
                if (currentCellId) {
                    const selectedId = modalSelect.value;
                    if (selectedId) {
                        timetableData[currentCellId] = selectedId;
                    } else {
                        delete timetableData[currentCellId];
                    }
                    updateCell(currentCellId);
                    saveData();
                }
                closeModal();
            });
            
            document.getElementById('modal-clear').addEventListener('click', () => {
                if (currentCellId) {
                    delete timetableData[currentCellId];
                    updateCell(currentCellId);
                    saveData();
                }
                closeModal();
            });

            document.getElementById('modal-cancel').addEventListener('click', closeModal);

            disciplineForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = disciplineIdInput.value;
                const newDiscipline = {
                    id: id ? parseInt(id) : Date.now(),
                    name: document.getElementById('discipline-name').value,
                    abbr: document.getElementById('discipline-abbr').value,
                    teacher: document.getElementById('discipline-teacher').value,
                    room: document.getElementById('discipline-room').value,
                    color: colorInput.value,
                    scheduleDays: Array.from(document.querySelectorAll('[name="schedule-day"]:checked')).map(cb => cb.value),
                    scheduleStartTime: document.getElementById('schedule-start-time').value,
                    scheduleEndTime: document.getElementById('schedule-end-time').value
                };

                if (id) {
                    disciplines = disciplines.map(d => d.id == id ? newDiscipline : d);
                } else {
                    disciplines.push(newDiscipline);
                }
                
                applyRecurringSchedule(newDiscipline);

                saveData();
                renderDisciplinesList();
                renderTimetable();
                resetForm();
            });

            const applyRecurringSchedule = (discipline) => {
                const { id, scheduleDays, scheduleStartTime, scheduleEndTime } = discipline;

                if (scheduleDays && scheduleDays.length > 0 && scheduleStartTime && scheduleEndTime) {
                    const startHour = parseInt(scheduleStartTime.split(':')[0]);
                    const endHour = parseInt(scheduleEndTime.split(':')[0]);

                    for (let hour = startHour; hour < endHour; hour++) {
                        const timeStr = `${String(hour).padStart(2, '0')}:00`;
                        scheduleDays.forEach(day => {
                            const cellId = `${day}-${timeStr}`;
                            timetableData[cellId] = id;
                        });
                    }
                }
            };

            const onEditDiscipline = (e) => {
                const id = e.target.dataset.id;
                const discipline = disciplines.find(d => d.id == id);
                if (discipline) {
                    formTitle.textContent = 'Editar Disciplina';
                    disciplineIdInput.value = discipline.id;
                    document.getElementById('discipline-name').value = discipline.name;
                    document.getElementById('discipline-abbr').value = discipline.abbr;
                    document.getElementById('discipline-teacher').value = discipline.teacher;
                    document.getElementById('discipline-room').value = discipline.room;
                    colorInput.value = discipline.color;
                    updatePaletteSelection(discipline.color);
                    
                    document.querySelectorAll('[name="schedule-day"]').forEach(cb => cb.checked = false);
                    document.getElementById('schedule-start-time').value = '';
                    document.getElementById('schedule-end-time').value = '';
                    
                    if (discipline.scheduleDays) {
                        discipline.scheduleDays.forEach(day => {
                            const checkbox = document.getElementById(`day-${day}`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    if (discipline.scheduleStartTime) {
                        document.getElementById('schedule-start-time').value = discipline.scheduleStartTime;
                    }
                    if (discipline.scheduleEndTime) {
                        document.getElementById('schedule-end-time').value = discipline.scheduleEndTime;
                    }

                    cancelEditBtn.classList.remove('hidden');
                    window.scrollTo({ top: document.getElementById('discipline-form').offsetTop, behavior: 'smooth' });
                }
            };

            const onDeleteDiscipline = (e) => {
                const id = e.target.dataset.id;
                if (confirm('Tem certeza que deseja excluir esta disciplina? Isso também a removerá do cronograma.')) {
                    disciplines = disciplines.filter(d => d.id != id);
                    Object.keys(timetableData).forEach(cellId => {
                        if (timetableData[cellId] == id) {
                            delete timetableData[cellId];
                            updateCell(cellId);
                        }
                    });
                    saveData();
                    renderDisciplinesList();
                }
            };

            const resetForm = () => {
                disciplineForm.reset();
                document.querySelectorAll('[name="schedule-day"]:checked').forEach(cb => cb.checked = false);
                disciplineIdInput.value = '';
                formTitle.textContent = 'Adicionar Nova Disciplina';
                cancelEditBtn.classList.add('hidden');
                const randomColor = predefinedColors[Math.floor(Math.random() * predefinedColors.length)];
                colorInput.value = randomColor;
                updatePaletteSelection(randomColor);
            };
            
            cancelEditBtn.addEventListener('click', resetForm);

            editPaletteBtn.addEventListener('click', () => {
                isEditingPalette = true;
                editPaletteBtn.classList.add('hidden');
                savePaletteBtn.classList.remove('hidden');
                resetPaletteBtn.classList.remove('hidden');
                colorPalette.classList.add('palette-editing');
            });

            savePaletteBtn.addEventListener('click', () => {
                isEditingPalette = false;
                editPaletteBtn.classList.remove('hidden');
                savePaletteBtn.classList.add('hidden');
                resetPaletteBtn.classList.add('hidden');
                colorPalette.classList.remove('palette-editing');
                saveData();
            });

            resetPaletteBtn.addEventListener('click', () => {
                if (confirm('Tem certeza que deseja resetar a paleta para as cores padrão?')) {
                    predefinedColors = [...defaultColors];
                    renderColorPalette();
                    saveData();
                }
            });

            document.getElementById('print-btn').addEventListener('click', () => {
                window.print();
            });

            document.getElementById('clear-all-btn').addEventListener('click', () => {
                if (confirm('Tem certeza que deseja limpar todo o cronograma e todas as disciplinas? Esta ação não pode ser desfeita.')) {
                    disciplines = [];
                    timetableData = {};
                    localStorage.removeItem('timetable_disciplines');
                    localStorage.removeItem('timetable_data');
                    localStorage.removeItem('timetable_color_palette');
                    predefinedColors = [...defaultColors];
                    renderTimetable();
                    renderDisciplinesList();
                    renderColorPalette();
                    resetForm();
                }
            });

            // --- INITIALIZATION ---
            const init = () => {
                loadData();
                renderDayCheckboxes();
                renderColorPalette();
                renderTimetable();
                renderDisciplinesList();
                resetForm();
            };

            init();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Cronograma</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        .palette-editing {
            outline: 2px dashed #4f46e5; /* indigo-600 */
            border-radius: 8px;
            padding: 4px;
        }
        
        @media print {
            @page {
                size: A4 landscape; 
                margin: 1cm;
            }
            body, html {
                width: 100%;
                height: auto;
                background-color: #ffffff !important;
                -webkit-print-color-adjust: exact !important; 
                color-adjust: exact !important;
                zoom: 80%;
            }
            .no-print {
                display: none !important;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            #timetable {
                min-width: 100%;
                table-layout: fixed;
            }
            th, td {
                border: 1px solid #ddd !important;
                padding: 2px;
                font-size: 8px; 
                word-break: break-word; 
            }
            th {
                background-color: #f2f2f2 !important;
            }
            .time-col {
                width: auto; 
                min-width: 0;
                white-space: nowrap;
            }
            #timetable div[style*="background-color"] {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            #print-legend {
                display: block !important;
                page-break-before: always;
                padding-top: 2cm;
            }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- App Container -->
    <div id="app-container">
        <!-- Main Container -->
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="text-center mb-8 no-print">
                <h1 class="text-4xl sm:text-5xl font-bold text-gray-800">Meu Cronograma Semanal</h1>
                <p class="text-gray-500 mt-2 text-lg">Organize suas atividades de forma simples e visual.</p>
            </header>

             <!-- Controls Section -->
            <div class="bg-white p-4 rounded-2xl shadow-lg no-print mb-8">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <button id="print-btn" class="flex items-center justify-center gap-2 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h1v-4a1 1 0 011-1h8a1 1 0 011 1v4h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm-6 8a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                        <span>Imprimir</span>
                    </button>
                    <button id="export-btn" class="flex items-center justify-center gap-2 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        <span>Exportar</span>
                    </button>
                    <button id="import-btn" class="flex items-center justify-center gap-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        <span>Importar</span>
                    </button>
                    <button id="clear-all-btn" class="flex items-center justify-center gap-2 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        <span>Limpar Tudo</span>
                    </button>
                    <a href="./compcrono.html" class="flex items-center justify-center gap-2 w-full text-center bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2.5 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" /></svg>
                        <span>Comparar</span>
                    </a>
                    <a href="./contfaltas.html" class="flex items-center justify-center gap-2 w-full text-center bg-orange-500 hover:bg-orange-600 text-white font-bold py-2.5 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                        <span>Faltas</span>
                    </a>
                    <input type="file" id="import-file-input" class="hidden" accept=".json">
                </div>
            </div>

            <!-- Timetable Section -->
            <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg">
                <div id="timetable-wrapper" class="overflow-x-auto custom-scrollbar">
                    <table id="timetable" class="w-full border-collapse text-center">
                        <thead class="bg-gray-50"></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Activities Management Section -->
            <div class="mt-10 no-print">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 id="form-title" class="text-xl font-semibold mb-4 text-gray-700">Adicionar Nova Atividade</h3>
                        <form id="activity-form" class="space-y-4">
                            <input type="hidden" id="activity-id">
                            <div>
                                <label for="activity-name" class="block text-sm font-medium text-gray-600">Nome da Atividade</label>
                                <input type="text" id="activity-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                            </div>
                            <div>
                                <label for="activity-abbr" class="block text-sm font-medium text-gray-600">Abreviação</label>
                                <input type="text" id="activity-abbr" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                            </div>
                            <div>
                                <label for="activity-responsible" class="block text-sm font-medium text-gray-600">Responsável</label>
                                <input type="text" id="activity-responsible" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="activity-location" class="block text-sm font-medium text-gray-600">Local</label>
                                <input type="text" id="activity-location" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                             <div>
                                <label for="activity-description" class="block text-sm font-medium text-gray-600">Descrição Padrão (Opcional)</label>
                                <textarea id="activity-description" rows="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
                            </div>
                            <div>
                                <label for="activity-color" class="block text-sm font-medium text-gray-600">Cor</label>
                                <input type="color" id="activity-color" value="#a7f3d0" class="mt-1 block w-full h-10 px-1 py-1 bg-white border border-gray-300 rounded-md shadow-sm cursor-pointer">
                            </div>
                            <div>
                                <div class="flex justify-between items-center mt-2">
                                    <label class="block text-sm font-medium text-gray-600">Paleta de Cores</label>
                                    <div>
                                        <button type="button" id="edit-palette-btn" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800">Editar</button>
                                        <button type="button" id="save-palette-btn" class="text-sm font-semibold text-green-600 hover:text-green-800 hidden">Salvar</button>
                                        <button type="button" id="reset-palette-btn" class="text-sm font-semibold text-red-600 hover:text-red-800 ml-2 hidden">Resetar</button>
                                    </div>
                                </div>
                                <div id="color-palette" class="flex flex-wrap gap-2 mt-2 p-1"></div>
                            </div>
                            <div class="border-t pt-4">
                                <h4 class="text-md font-semibold text-gray-700 mb-2">Horário Recorrente (Opcional)</h4>
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-600 mb-2">Dias da Semana</label>
                                    <div id="schedule-days" class="flex flex-wrap gap-x-4 gap-y-2"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="schedule-start-time" class="block text-sm font-medium text-gray-600">Hora Início</label>
                                        <input type="time" id="schedule-start-time" step="3600" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="schedule-end-time" class="block text-sm font-medium text-gray-600">Hora Fim</label>
                                        <input type="time" id="schedule-end-time" step="3600" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-4 pt-4">
                                <button type="submit" id="save-activity-btn" class="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Adicionar/Atualizar Atividade</button>
                                <button type="button" id="cancel-edit-btn" class="w-full flex justify-center py-2.5 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 hidden">Cancelar</button>
                            </div>
                        </form>
                    </div>
                    <div id="activities-list-container" class="bg-white p-6 rounded-2xl shadow-lg">
                         <h3 class="text-xl font-semibold mb-4 text-gray-700">Minhas Atividades</h3>
                         <div id="activities-list" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for selecting activity -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-md shadow-lg rounded-2xl bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Selecione a Atividade</h3>
                    <div class="mt-4 px-2 py-3 space-y-4">
                        <select id="modal-activity-select" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
                        <div>
                            <label for="modal-description" class="block text-sm text-left font-medium text-gray-600">Descrição Específica (Opcional)</label>
                            <input type="text" id="modal-description" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                    </div>
                    <div class="items-center px-4 py-3 gap-3 grid grid-cols-1 sm:grid-cols-3">
                         <button id="modal-save" class="w-full justify-center rounded-md border border-transparent bg-green-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-green-700">Salvar</button>
                        <button id="modal-clear" class="w-full justify-center rounded-md border border-transparent bg-orange-500 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-orange-600">Limpar</button>
                        <button id="modal-cancel" class="w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 sm:col-span-3">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirm-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-sm w-full">
                <h3 id="confirm-modal-title" class="text-lg font-semibold text-gray-800 mb-2">Confirmar Ação</h3>
                <p id="confirm-modal-text" class="text-gray-600 mb-4">Você tem certeza?</p>
                <div class="flex justify-end gap-4">
                    <button id="confirm-modal-no" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Não</button>
                    <button id="confirm-modal-yes" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Sim</button>
                </div>
            </div>
        </div>

        <!-- Print Legend Section -->
        <div id="print-legend" class="hidden"></div>
    </div> 
    
    <footer class="text-center p-4 mt-8 no-print">
        <p class="text-sm text-gray-500">
            Desenvolvido por <a href="https://github.com/Jeanlsg" target="_blank" class="font-semibold text-indigo-600 hover:underline">Jean.Guimaraes</a>
        </p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const timetable = document.getElementById('timetable');
            const modal = document.getElementById('modal');
            const modalSelect = document.getElementById('modal-activity-select');
            const modalDescriptionInput = document.getElementById('modal-description');
            const activityForm = document.getElementById('activity-form');
            const activitiesList = document.getElementById('activities-list');
            const formTitle = document.getElementById('form-title');
            const activityIdInput = document.getElementById('activity-id');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const scheduleDaysContainer = document.getElementById('schedule-days');
            const colorPalette = document.getElementById('color-palette');
            const colorInput = document.getElementById('activity-color');
            const editPaletteBtn = document.getElementById('edit-palette-btn');
            const savePaletteBtn = document.getElementById('save-palette-btn');
            const resetPaletteBtn = document.getElementById('reset-palette-btn');
            const confirmModal = document.getElementById('confirm-modal');
            const importFileInput = document.getElementById('import-file-input');

            // App State
            let activities = [];
            let timetableData = {};
            let currentCellId = null;
            let isEditingPalette = false;

            // Constants
            const days = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
            const startTime = 7;
            const endTime = 23;
            const defaultColors = ['#fecaca', '#fed7aa', '#fef08a', '#d9f99d', '#a7f3d0', '#bfdbfe', '#c7d2fe', '#e9d5ff', '#fbcfe8', '#fce7f3', '#e5e7eb', '#d1d5db'];
            let predefinedColors = [...defaultColors];

            const defaultActivities = [
                { id: 1, name: 'Trabalho', abbr: 'Job', responsible: 'Chefe', location: 'Escritório', color: '#c7d2fe', description: 'Reunião de equipe' },
                { id: 2, name: 'Estudar', abbr: 'Estudo', responsible: 'Eu', location: 'Biblioteca', color: '#fed7aa', description: 'Revisar matéria' },
                { id: 3, name: 'Academia', abbr: 'Gym', responsible: 'Personal', location: 'SmartFit', color: '#fecaca', description: 'Treino de pernas' },
                { id: 4, name: 'Almoço', abbr: 'Almoço', responsible: '', location: 'Restaurante', color: '#d9f99d', description: '' },
                { id: 5, name: 'Jantar', abbr: 'Jantar', responsible: 'Eu', location: 'Casa', color: '#e9d5ff', description: '' },
                { id: 6, name: 'Projeto Pessoal', abbr: 'Proj.', responsible: 'Eu', location: 'Casa', color: '#a7f3d0', description: 'Codificar app' },
                { id: 7, name: 'Descansar', abbr: 'Zzz', responsible: '', location: 'Casa', color: '#e5e7eb', description: 'Assistir série' },
            ];
            
            const defaultTimetableData = {
                // Generic Schedule
                'Seg-08:00': { activityId: 1, description: 'Reunião de alinhamento' }, 'Seg-09:00': { activityId: 1, description: '' }, 'Seg-10:00': { activityId: 1, description: '' }, 'Seg-11:00': { activityId: 1, description: '' },
                'Ter-08:00': { activityId: 1, description: '' }, 'Ter-09:00': { activityId: 1, description: '' }, 'Ter-10:00': { activityId: 1, description: '' }, 'Ter-11:00': { activityId: 1, description: '' },
                'Qua-08:00': { activityId: 1, description: '' }, 'Qua-09:00': { activityId: 1, description: '' }, 'Qua-10:00': { activityId: 1, description: '' }, 'Qua-11:00': { activityId: 1, description: '' },
                'Qui-08:00': { activityId: 1, description: '' }, 'Qui-09:00': { activityId: 1, description: '' }, 'Qui-10:00': { activityId: 1, description: '' }, 'Qui-11:00': { activityId: 1, description: '' },
                'Sex-08:00': { activityId: 1, description: '' }, 'Sex-09:00': { activityId: 1, description: '' }, 'Sex-10:00': { activityId: 1, description: '' }, 'Sex-11:00': { activityId: 1, description: '' },

                'Seg-12:00': { activityId: 4, description: '' }, 'Ter-12:00': { activityId: 4, description: '' }, 'Qua-12:00': { activityId: 4, description: '' }, 'Qui-12:00': { activityId: 4, description: '' }, 'Sex-12:00': { activityId: 4, description: '' },
                'Seg-19:00': { activityId: 5, description: 'Cuscuz' },
                'Ter-19:00': { activityId: 5, description: 'Sopa' },
                'Qua-19:00': { activityId: 5, description: 'Macarronada' },
                'Qui-19:00': { activityId: 5, description: 'Salada' },
                'Sex-19:00': { activityId: 5, description: 'Pizza' },
                'Seg-18:00': { activityId: 3, description: 'Peito e Tríceps' }, 'Qua-18:00': { activityId: 3, description: 'Costas e Bíceps' }, 'Sex-18:00': { activityId: 3, description: 'Pernas' },
                'Ter-20:00': { activityId: 2, description: 'Inglês' }, 'Qui-20:00': { activityId: 2, description: 'Espanhol' },
                'Sáb-14:00': { activityId: 6, description: '' }, 'Sáb-15:00': { activityId: 6, description: '' },
                'Dom-16:00': { activityId: 7, description: 'Filme novo' },
            };

            // --- CONFIRMATION MODAL ---
            const showConfirm = (title, text, onYes) => {
                document.getElementById('confirm-modal-title').textContent = title;
                document.getElementById('confirm-modal-text').textContent = text;
                confirmModal.classList.remove('hidden');

                const yesBtn = document.getElementById('confirm-modal-yes');
                const noBtn = document.getElementById('confirm-modal-no');

                const handleYes = () => {
                    onYes();
                    cleanup();
                };

                const cleanup = () => {
                    confirmModal.classList.add('hidden');
                    yesBtn.removeEventListener('click', handleYes);
                    noBtn.removeEventListener('click', cleanup);
                };

                yesBtn.addEventListener('click', handleYes, { once: true });
                noBtn.addEventListener('click', cleanup, { once: true });
            };

            // --- DATA PERSISTENCE (LocalStorage) ---
            const saveData = () => {
                localStorage.setItem('timetable_disciplines', JSON.stringify(activities));
                localStorage.setItem('timetable_data', JSON.stringify(timetableData));
                localStorage.setItem('timetable_color_palette', JSON.stringify(predefinedColors));
            };

            const loadData = () => {
                const storedActivities = localStorage.getItem('timetable_disciplines');
                const storedTimetableData = localStorage.getItem('timetable_data');
                const storedPalette = localStorage.getItem('timetable_color_palette');

                activities = storedActivities ? JSON.parse(storedActivities) : defaultActivities;
                timetableData = storedTimetableData ? JSON.parse(storedTimetableData) : defaultTimetableData;
                predefinedColors = storedPalette ? JSON.parse(storedPalette) : [...defaultColors];
            };

            // --- RENDER FUNCTIONS ---
            const renderPrintLegend = () => {
                const legendContainer = document.getElementById('print-legend');
                if (!legendContainer) return;
                let legendHTML = '<h2 style="font-size: 24px; font-weight: bold; margin-bottom: 16px;">Legenda de Abreviações</h2><ul>';
                const uniqueActivities = [...new Map(activities.map(item => [item.abbr, item])).values()];
                uniqueActivities.forEach(d => {
                    if (d.abbr && d.name) {
                        const locationInfo = d.location ? ` - ${d.location}` : '';
                         legendHTML += `<li style="font-size: 16px; margin-bottom: 8px;"><strong style="font-weight: bold;">${d.abbr}:</strong> ${d.name}${locationInfo}</li>`;
                    }
                });
                legendHTML += '</ul>';
                legendContainer.innerHTML = legendHTML;
            };

            const fullRender = () => {
                renderTimetable();
                renderActivitiesList();
                renderColorPalette();
                updatePaletteSelection(colorInput.value);
                renderPrintLegend();
            };

            const renderTimetable = () => {
                timetable.innerHTML = '';
                const thead = timetable.createTHead();
                thead.classList.add('bg-gray-50');
                const headerRow = thead.insertRow();
                const timeHeader = document.createElement('th');
                timeHeader.className = 'p-2 border border-gray-200 sticky left-0 bg-gray-100 z-10 time-col text-xs font-semibold text-gray-600 uppercase tracking-wider';
                timeHeader.textContent = 'Horário';
                headerRow.appendChild(timeHeader);
                days.forEach(day => {
                    const th = document.createElement('th');
                    th.className = 'p-2 border border-gray-200 text-xs font-semibold text-gray-600 uppercase tracking-wider';
                    th.textContent = day;
                    headerRow.appendChild(th);
                });

                const tbody = timetable.createTBody();
                for (let hour = startTime; hour < endTime; hour++) {
                    const timeStr = `${String(hour).padStart(2, '0')}:00`;
                    const nextHourStr = `${String(hour + 1).padStart(2, '0')}:00`;
                    const timeRangeStr = `${timeStr} ~ ${nextHourStr}`;
                    
                    const row = tbody.insertRow();
                    
                    const timeCell = row.insertCell();
                    timeCell.textContent = timeRangeStr;
                    timeCell.className = 'p-1 border border-gray-200 font-mono text-[10px] sm:text-xs text-gray-500 sticky left-0 bg-white z-10 time-col whitespace-nowrap';

                    days.forEach(day => {
                        const cell = row.insertCell();
                        const cellId = `${day}-${timeStr}`;
                        cell.id = cellId;
                        cell.className = 'p-0 border border-gray-200 h-14 cursor-pointer hover:bg-gray-50 transition-colors duration-200';
                        cell.addEventListener('click', () => onCellClick(cellId));
                        updateCell(cellId);
                    });
                }
            };

            const updateCell = (cellId) => {
                const cell = document.getElementById(cellId);
                if (!cell) return;
                const entry = timetableData[cellId];
                if (entry && entry.activityId) {
                    const activity = activities.find(d => d.id == entry.activityId);
                    if (activity) {
                        const description = entry.description || activity.description || '';
                        cell.innerHTML = `<div class="w-full h-full flex flex-col items-center justify-center text-gray-800 font-semibold p-1 overflow-hidden" style="background-color: ${activity.color};">
                            <span class="text-xs">${activity.abbr}</span>
                            <span class="text-[10px] font-normal text-gray-600 truncate mt-1">${description}</span>
                        </div>`;
                    } else {
                        // Data inconsistency, clear the cell
                        delete timetableData[cellId];
                        cell.innerHTML = '';
                    }
                } else {
                    cell.innerHTML = '';
                }
            };

            const renderActivitiesList = () => {
                activitiesList.innerHTML = '';
                if(activities.length === 0) {
                    activitiesList.innerHTML = `<p class="text-gray-500">Nenhuma atividade adicionada ainda.</p>`;
                    return;
                }
                activities.forEach(d => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors';
                    div.innerHTML = `
                        <div class="flex items-center gap-4 flex-1 min-w-0">
                            <div class="w-4 h-4 rounded-full flex-shrink-0" style="background-color: ${d.color};"></div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-gray-800 truncate">${d.name} <span class="text-gray-500">(${d.abbr})</span></p>
                                <p class="text-sm text-gray-500 truncate">${d.responsible || 'Sem responsável'} - ${d.location || 'Sem local'}</p>
                                ${d.description ? `<p class="text-xs text-gray-400 truncate mt-1">Padrão: ${d.description}</p>` : ''}
                            </div>
                        </div>
                        <div class="flex gap-2 flex-shrink-0 ml-4">
                            <button data-id="${d.id}" class="edit-btn p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors" title="Editar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button data-id="${d.id}" class="delete-btn p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Excluir">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    `;
                    activitiesList.appendChild(div);
                });
                document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', onEditActivity));
                document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', onDeleteActivity));
            };
            
            const populateModalSelect = () => {
                modalSelect.innerHTML = '<option value="">-- Limpar Célula --</option>';
                activities.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d.id;
                    option.textContent = `${d.name} (${d.abbr})`;
                    modalSelect.appendChild(option);
                });
            };
            
            const renderDayCheckboxes = () => {
                scheduleDaysContainer.innerHTML = '';
                days.forEach(day => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    div.innerHTML = `
                        <input id="day-${day}" name="schedule-day" type="checkbox" value="${day}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="day-${day}" class="ml-2 block text-sm text-gray-900">${day}</label>
                    `;
                    scheduleDaysContainer.appendChild(div);
                });
            };

            const renderColorPalette = () => {
                colorPalette.innerHTML = '';
                predefinedColors.forEach((color, index) => {
                    const swatch = document.createElement('div');
                    swatch.className = 'w-8 h-8 rounded-full cursor-pointer border-2 border-transparent hover:border-gray-500 transition-all';
                    swatch.style.backgroundColor = color;
                    swatch.dataset.color = color;
                    swatch.dataset.index = index;
                    swatch.addEventListener('click', onSwatchClick);
                    colorPalette.appendChild(swatch);
                });
            };

            const updatePaletteSelection = (selectedColor) => {
                document.querySelectorAll('#color-palette div').forEach(swatch => {
                    if (swatch.dataset.color.toLowerCase() === selectedColor.toLowerCase()) {
                        swatch.classList.add('border-gray-800', 'scale-110');
                        swatch.classList.remove('border-transparent');
                    } else {
                        swatch.classList.remove('border-gray-800', 'scale-110');
                        swatch.classList.add('border-transparent');
                    }
                });
            };

            // --- EVENT HANDLERS ---
            const onSwatchClick = (e) => {
                const swatch = e.target;
                const selectedColor = swatch.dataset.color;

                if (isEditingPalette) {
                    const index = parseInt(swatch.dataset.index);
                    const tempColorInput = document.createElement('input');
                    tempColorInput.type = 'color';
                    tempColorInput.value = selectedColor;
                    tempColorInput.style.display = 'none';
                    document.body.appendChild(tempColorInput);
                    
                    tempColorInput.addEventListener('input', (event) => {
                        const newColor = event.target.value;
                        predefinedColors[index] = newColor;
                        renderColorPalette();
                        updatePaletteSelection(newColor);
                        document.body.removeChild(tempColorInput);
                    }, { once: true });

                    tempColorInput.click();
                } else {
                    colorInput.value = selectedColor;
                    updatePaletteSelection(selectedColor);
                }
            };

            colorInput.addEventListener('input', (e) => {
                updatePaletteSelection(e.target.value);
            });

            const onCellClick = (cellId) => {
                currentCellId = cellId;
                populateModalSelect();
                const entry = timetableData[cellId];
                if (entry) {
                    modalSelect.value = entry.activityId;
                    modalDescriptionInput.value = entry.description || '';
                } else {
                    modalSelect.value = '';
                    modalDescriptionInput.value = '';
                }
                modal.classList.remove('hidden');
            };

            const closeModal = () => {
                modal.classList.add('hidden');
                currentCellId = null;
            };

            document.getElementById('modal-save').addEventListener('click', () => {
                if (currentCellId) {
                    const selectedId = modalSelect.value;
                    const specificDescription = modalDescriptionInput.value;
                    if (selectedId) {
                        const activity = activities.find(a => a.id == selectedId);
                        timetableData[currentCellId] = { 
                            activityId: selectedId, 
                            description: specificDescription || activity.description || ''
                        };
                    } else {
                        delete timetableData[currentCellId];
                    }
                    updateCell(currentCellId);
                    saveData();
                }
                closeModal();
            });
            
            document.getElementById('modal-clear').addEventListener('click', () => {
                if (currentCellId) {
                    delete timetableData[currentCellId];
                    updateCell(currentCellId);
                    saveData();
                }
                closeModal();
            });

            document.getElementById('modal-cancel').addEventListener('click', closeModal);

            activityForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = activityIdInput.value;
                
                const scheduleDays = Array.from(document.querySelectorAll('[name="schedule-day"]:checked')).map(cb => cb.value);
                const scheduleStartTime = document.getElementById('schedule-start-time').value;
                const scheduleEndTime = document.getElementById('schedule-end-time').value;

                const newActivity = {
                    id: id ? parseInt(id) : Date.now(),
                    name: document.getElementById('activity-name').value,
                    abbr: document.getElementById('activity-abbr').value,
                    responsible: document.getElementById('activity-responsible').value,
                    location: document.getElementById('activity-location').value,
                    description: document.getElementById('activity-description').value,
                    color: colorInput.value,
                    scheduleDays: scheduleDays,
                    scheduleStartTime: scheduleStartTime,
                    scheduleEndTime: scheduleEndTime
                };

                if (id) {
                    activities = activities.map(d => d.id == id ? newActivity : d);
                } else {
                    activities.push(newActivity);
                }
                
                applyRecurringSchedule(newActivity);
                saveData();
                fullRender();
                resetForm();
            });

            const applyRecurringSchedule = (activity) => {
                const { id, scheduleDays, scheduleStartTime, scheduleEndTime } = activity;

                if (scheduleDays && scheduleDays.length > 0 && scheduleStartTime && scheduleEndTime) {
                    const startHour = parseInt(scheduleStartTime.split(':')[0]);
                    const endHour = parseInt(scheduleEndTime.split(':')[0]);

                    for (let hour = startHour; hour < endHour; hour++) {
                        const timeStr = `${String(hour).padStart(2, '0')}:00`;
                        scheduleDays.forEach(day => {
                            const cellId = `${day}-${timeStr}`;
                            timetableData[cellId] = {
                                activityId: activity.id,
                                description: activity.description || ''
                            };
                        });
                    }
                }
            };

            const onEditActivity = (e) => {
                const button = e.target.closest('button');
                const id = button.dataset.id;
                const activity = activities.find(d => d.id == id);
                if (activity) {
                    formTitle.textContent = 'Editar Atividade';
                    activityIdInput.value = activity.id;
                    document.getElementById('activity-name').value = activity.name;
                    document.getElementById('activity-abbr').value = activity.abbr;
                    document.getElementById('activity-responsible').value = activity.responsible;
                    document.getElementById('activity-location').value = activity.location;
                    document.getElementById('activity-description').value = activity.description;
                    colorInput.value = activity.color;
                    updatePaletteSelection(activity.color);
                    
                    document.querySelectorAll('[name="schedule-day"]').forEach(cb => cb.checked = false);
                    
                    if (activity.scheduleDays) {
                        activity.scheduleDays.forEach(day => {
                            const checkbox = document.getElementById(`day-${day}`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    document.getElementById('schedule-start-time').value = activity.scheduleStartTime || '';
                    document.getElementById('schedule-end-time').value = activity.scheduleEndTime || '';

                    cancelEditBtn.classList.remove('hidden');
                    window.scrollTo({ top: document.getElementById('activity-form').offsetTop, behavior: 'smooth' });
                }
            };

            const onDeleteActivity = (e) => {
                const button = e.target.closest('button');
                const idToDelete = button.dataset.id;
                showConfirm('Excluir Atividade', 'Tem certeza que deseja excluir esta atividade? Isso também a removerá de todo o cronograma.', () => {
                    activities = activities.filter(d => d.id != idToDelete);
                    Object.keys(timetableData).forEach(cellId => {
                        if (timetableData[cellId].activityId == idToDelete) {
                            delete timetableData[cellId];
                        }
                    });
                    saveData();
                    fullRender();
                });
            };

            const resetForm = () => {
                activityForm.reset();
                document.querySelectorAll('[name="schedule-day"]:checked').forEach(cb => cb.checked = false);
                activityIdInput.value = '';
                formTitle.textContent = 'Adicionar Nova Atividade';
                cancelEditBtn.classList.add('hidden');
                const randomColor = predefinedColors[Math.floor(Math.random() * predefinedColors.length)];
                colorInput.value = randomColor;
                updatePaletteSelection(randomColor);
            };
            
            cancelEditBtn.addEventListener('click', resetForm);
            
            editPaletteBtn.addEventListener('click', () => {
                isEditingPalette = true;
                editPaletteBtn.classList.add('hidden');
                savePaletteBtn.classList.remove('hidden');
                resetPaletteBtn.classList.remove('hidden');
                colorPalette.classList.add('palette-editing');
            });

            savePaletteBtn.addEventListener('click', () => {
                isEditingPalette = false;
                editPaletteBtn.classList.remove('hidden');
                savePaletteBtn.classList.add('hidden');
                resetPaletteBtn.classList.add('hidden');
                colorPalette.classList.remove('palette-editing');
                saveData();
            });

            resetPaletteBtn.addEventListener('click', () => {
                showConfirm('Resetar Paleta', 'Tem certeza que deseja resetar a paleta para as cores padrão?', () => {
                    predefinedColors = [...defaultColors];
                    saveData();
                    fullRender();
                });
            });

            document.getElementById('print-btn').addEventListener('click', () => window.print());
            
            document.getElementById('clear-all-btn').addEventListener('click', () => {
                showConfirm('Limpar Tudo', 'Tem certeza que deseja limpar todo o cronograma e todas as atividades? Esta ação não pode ser desfeita.', () => {
                    activities = [];
                    timetableData = {};
                    predefinedColors = [...defaultColors];
                    saveData();
                    fullRender();
                    resetForm();
                });
            });

            // --- IMPORT/EXPORT HANDLERS ---
            document.getElementById('export-btn').addEventListener('click', () => {
                const dataToExport = {
                    activities,
                    timetableData,
                    predefinedColors
                };
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.download = 'cronograma-backup.json';
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
            });

            document.getElementById('import-btn').addEventListener('click', () => {
                importFileInput.click();
            });

            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.activities && importedData.timetableData && importedData.predefinedColors) {
                             showConfirm('Importar Dados', 'Isso substituirá seu cronograma atual. Deseja continuar?', () => {
                                activities = importedData.activities;
                                timetableData = importedData.timetableData;
                                predefinedColors = importedData.predefinedColors;
                                saveData();
                                fullRender();
                            });
                        } else {
                            alert('Arquivo de importação inválido. A estrutura dos dados está incorreta.');
                        }
                    } catch (error) {
                        console.error("Error parsing imported file:", error);
                        alert('Não foi possível ler o arquivo. Verifique se é um arquivo JSON válido.');
                    } finally {
                        importFileInput.value = '';
                    }
                };
                reader.readAsText(file);
            });


            // --- INITIALIZATION ---
            const init = () => {
                loadData();
                renderDayCheckboxes();
                fullRender();
                resetForm();
            };

            init();
        });
    </script>
</body>
</html>
